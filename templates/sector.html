{% extends "base.html" %}

{% block content %}
<h1>Sector Analysis of S&P 500 Companies</h1>
<p>Sector Analysis analyzes the performance of each sector.</p>

    <h2>Company Count by Sector</h2>
    <div class="chart-container">
        <canvas id="companyPieChart"></canvas>
    </div>

    <h2>Market Capitalization by Sector</h2>
    <div class="chart-container">
        <canvas id="marketCapPieChart"></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <script>
        async function fetchSectorData() {
            try {
                let response = await fetch('/api/sector_analysis');
                if (!response.ok) {
                    throw new Error("Error fetching sector data");
                }
                let data = await response.json();
                createCharts(data);
            } catch (error) {
                console.error("Failed to load data:", error);
            }
        }

        function createCharts(data) {
            const ctx1 = document.getElementById('companyPieChart').getContext('2d');
            const companyChart = new Chart(ctx1, {
                type: 'pie',
                data: {
                    labels: data.sectors,
                    datasets: [{
                        label: 'Company Count by Sector',
                        data: data.company_counts,
                        backgroundColor: generateColors(data.sectors.length),
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Company Count by Sector',
                            font: { size: 18 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(tooltipItem) {
                                    let value = tooltipItem.raw;
                                    return ` ${data.sectors[tooltipItem.dataIndex]}: ${value} companies`;
                                }
                            }
                        },
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                font: { size: 14 },
                                padding: 15
                            }
                        }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true
                    }
                }
            });

            const ctx2 = document.getElementById('marketCapPieChart').getContext('2d');
            const marketChart = new Chart(ctx2, {
                type: 'pie',
                data: {
                    labels: data.sectors,
                    datasets: [{
                        label: 'Market Capitalization by Sector',
                        data: data.market_caps,
                        backgroundColor: generateColors(data.sectors.length),
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Market Capitalization by Sector',
                            font: { size: 18 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(tooltipItem) {
                                    let value = tooltipItem.raw.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
                                    return ` ${data.sectors[tooltipItem.dataIndex]}: ${value}`;
                                }
                            }
                        },
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                font: { size: 14 },
                                padding: 15
                            }
                        }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true
                    }
                }
            });

            document.getElementById('companyPieChart').onclick = function(evt) {
                const points = companyChart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
                if (points.length) {
                    let index = points[0].index;
                    alert(`Sector: ${data.sectors[index]}\nCompanies: ${data.company_counts[index]}`);
                }
            };

            document.getElementById('marketCapPieChart').onclick = function(evt) {
                const points = marketChart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
                if (points.length) {
                    let index = points[0].index;
                    alert(`Sector: ${data.sectors[index]}\nMarket Cap: ${data.market_caps[index].toLocaleString('en-US', { style: 'currency', currency: 'USD' })}`);
                }
            };
        }

        function generateColors(length) {
            const colors = [
                'rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)',
                'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)',
                'rgba(100, 181, 246, 0.7)', 'rgba(156, 204, 101, 0.7)', 'rgba(240, 98, 146, 0.7)',
                'rgba(255, 167, 38, 0.7)', 'rgba(121, 85, 72, 0.7)', 'rgba(63, 81, 181, 0.7)'
            ];
            return colors.slice(0, length);
        }

        fetchSectorData();
    </script>

{% endblock %}